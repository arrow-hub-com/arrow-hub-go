<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calendar - Arrow Hub</title>

    <!-- FullCalendar CSS
         NOTE: some CDN bundle paths (e.g. fullcalendar@6.x index.global.min.css) may 404 on jsDelivr.
         Use the modular @fullcalendar/* CSS files which are available on jsDelivr for v6.1.10. -->
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/main.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/main.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.10/main.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.10/main.min.css" rel="stylesheet" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 0;
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1em;
        }

        .calendar-wrapper {
            background: white;
            padding: 30px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #calendar {
            max-width: 100%;
        }

        /* Loading indicator */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(103, 126, 234, 0.95);
            color: white;
            padding: 20px 40px;
            border-radius: 8px;
            z-index: 9999;
            font-weight: 500;
        }

        .loading.active {
            display: block;
        }

        /* Refresh button */
        .refresh-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #667eea;
            color: white;
        }

        /* FullCalendar Customization */
        .fc {
            font-family: inherit;
        }

        .fc-toolbar-title {
            font-size: 1.5em !important;
            font-weight: 600;
        }

        .fc-button {
            background: #667eea !important;
            border: none !important;
            text-transform: capitalize;
            padding: 8px 16px !important;
        }

        .fc-button:hover {
            background: #5568d3 !important;
        }

        .fc-button-active {
            background: #764ba2 !important;
        }

        /* Event colors by status */
        .fc-event.event-pending {
            background-color: #ffc107 !important;
            border-color: #e0a800 !important;
            color: #000 !important;
        }

        .fc-event.event-confirmed {
            background-color: #28a745 !important;
            border-color: #218838 !important;
        }

        .fc-event.event-declined {
            background-color: #dc3545 !important;
            border-color: #bd2130 !important;
        }

        .fc-event.event-cancelled {
            background-color: #6c757d !important;
            border-color: #545b62 !important;
        }

        .fc-event.event-block {
            background-color: #e0e0e0 !important;
            border-color: #bdbdbd !important;
            color: #424242 !important;
            font-style: italic;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #bd2130;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            color: white;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.8;
        }

        .close:hover {
            opacity: 1;
        }

        /* Status badge */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: #ffc107;
            color: #000;
        }

        .status-badge.confirmed {
            background: #28a745;
            color: white;
        }

        .status-badge.declined {
            background: #dc3545;
            color: white;
        }

        .status-badge.cancelled {
            background: #6c757d;
            color: white;
        }

        /* Detail view */
        .detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 500;
            color: #666;
            width: 140px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #333;
            flex: 1;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 20px;
            }
            
            .calendar-wrapper {
                padding: 15px;
            }
            
            .detail-row {
                flex-direction: column;
            }
            
            .detail-label {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading indicator -->
    <div class="loading" id="loadingIndicator">Loading calendar data...</div>
    
    <div class="container">
        <div class="header">
            <button class="refresh-btn" onclick="refreshCalendar()">â†» Refresh</button>
            <h1>Booking Calendar</h1>
            <p>Manage your bookings and availability - <span id="userEmail">Loading...</span></p>
        </div>
        
        <div class="calendar-wrapper">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- Booking Form Modal -->
    <div id="formModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" onclick="closeModal('formModal')">&times;</button>
                <h2 id="formModalTitle">New Booking</h2>
            </div>
            <div class="modal-body">
                <form id="bookingForm" onsubmit="event.preventDefault(); saveBooking();">
                    <input type="hidden" id="formBookingId" value="">
                    <input type="hidden" id="formBookingType" value="booking">
                    
                    <!-- Booking Fields -->
                    <div id="bookingFields">
                        <div class="form-group">
                            <label for="formClientName">Client Name *</label>
                            <input type="text" id="formClientName" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="formClientEmail">Client Email</label>
                                <input type="email" id="formClientEmail">
                            </div>
                            <div class="form-group">
                                <label for="formClientPhone">Client Phone</label>
                                <input type="tel" id="formClientPhone">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="formClientCompany">Company/Agency</label>
                            <input type="text" id="formClientCompany">
                        </div>
                        
                        <div class="form-group">
                            <label for="formClientSocials">Social Media URL</label>
                            <input type="url" id="formClientSocials">
                        </div>
                        
                        <div class="form-group">
                            <label for="formClientPortfolio">Portfolio URL</label>
                            <input type="url" id="formClientPortfolio">
                        </div>
                        
                        <div class="form-group">
                            <label for="formClientReferences">References URL</label>
                            <input type="url" id="formClientReferences">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="formDate">Date *</label>
                                <input type="date" id="formDate" required>
                            </div>
                            <div class="form-group">
                                <label for="formStartTime">Start Time *</label>
                                <input type="time" id="formStartTime" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="formEndTime">End Time *</label>
                                <input type="time" id="formEndTime" required>
                            </div>
                            <div class="form-group">
                                <label for="formDuration">Duration (minutes)</label>
                                <input type="number" id="formDuration" value="60" min="15" step="15">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="formStatus">Status</label>
                            <select id="formStatus">
                                <option value="Confirmed">Confirmed</option>
                                <option value="Pending">Pending</option>
                                <option value="Declined">Declined</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="formShootLevel">Shoot Level</label>
                            <select id="formShootLevel">
                                <option value="">Select...</option>
                                <option value="Portrait">Portrait</option>
                                <option value="Fashion">Fashion</option>
                                <option value="Glamour">Glamour</option>
                                <option value="Lingerie">Lingerie</option>
                                <option value="Artistic Nude">Artistic Nude</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Editorial">Editorial</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="formShootAddress">Location/Address</label>
                            <input type="text" id="formShootAddress">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="formTotalPayment">Amount Quoted (Â£)</label>
                                <input type="number" id="formTotalPayment" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="formCompensation">Payment Type</label>
                                <select id="formCompensation">
                                    <option value="">Select...</option>
                                    <option value="Full Pay">Full Pay</option>
                                    <option value="Part Pay">Part Pay</option>
                                    <option value="TF">TF (Time for)</option>
                                    <option value="Collaboration">Collaboration</option>
                                    <option value="Commercial">Commercial</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="formEmergencyEmail">Emergency Contact Email</label>
                            <input type="email" id="formEmergencyEmail">
                        </div>
                        
                        <div class="form-group">
                            <label for="formNotes">Notes</label>
                            <textarea id="formNotes"></textarea>
                        </div>
                    </div>
                    
                    <!-- Block Fields -->
                    <div id="blockFields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="formBlockDate">Date *</label>
                                <input type="date" id="formBlockDate" required>
                            </div>
                            <div class="form-group">
                                <label for="formBlockType">Block Type</label>
                                <select id="formBlockType">
                                    <option value="Busy">Busy</option>
                                    <option value="Away">Away</option>
                                    <option value="Holiday">Holiday</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="formAllDay" onchange="toggleTimeFields()">
                                All Day
                            </label>
                        </div>
                        
                        <div class="form-row" id="blockTimeFields">
                            <div class="form-group">
                                <label for="formBlockStartTime">Start Time</label>
                                <input type="time" id="formBlockStartTime">
                            </div>
                            <div class="form-group">
                                <label for="formBlockEndTime">End Time</label>
                                <input type="time" id="formBlockEndTime">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="formBlockNotes">Notes</label>
                            <textarea id="formBlockNotes"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('formModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Event Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" onclick="closeModal('viewModal')">&times;</button>
                <h2 id="viewModalTitle">Event Details</h2>
            </div>
            <div class="modal-body">
                <div id="viewContent"></div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('viewModal')">Close</button>
                    <button class="btn btn-primary" onclick="editEvent()">Edit</button>
                    <button class="btn btn-danger" onclick="deleteEvent()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FullCalendar JS (global bundle) -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <script>
        // Configuration - UPDATE THIS with your actual Apps Script URL
        const CONFIG = {
            appsScriptUrl: 'https://script.google.com/macros/s/AKfycbySK3LL4XcJdFZHfcv-xCfhiKWWKNnY9TXie02dTeHJ81nhls6VF9rAzBJKOh1c9cOF/exec',
            photographerEmail: 'photographer@example.com' // Default email, will be overridden by URL param
        };

        let calendar;
        let allEvents = [];
        let currentEvent = null;

        // Utility: get photographer email from URL param or default
        function getPhotographerEmail() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('email') || CONFIG.photographerEmail;
        }

        // Utility: show/hide loading indicator
        function showLoading(flag) {
            const el = document.getElementById('loadingIndicator');
            if (!el) return;
            if (flag) el.classList.add('active');
            else el.classList.remove('active');
        }

        // Utility: safe field getter (tries multiple possible key names)
        function getField(obj, ...keys) {
            for (const k of keys) {
                if (obj && typeof obj[k] !== 'undefined' && obj[k] !== null) return obj[k];
            }
            return undefined;
        }

        // Utility: add days to YYYY-MM-DD date string
        function addDaysToDateString(dateStr, days) {
            if (!dateStr) return dateStr;
            const parts = dateStr.split('-').map(p => parseInt(p, 10));
            if (parts.length !== 3 || isNaN(parts[0])) return dateStr;
            const d = new Date(parts[0], parts[1] - 1, parts[2]);
            d.setDate(d.getDate() + days);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        // Map booking object from server to FullCalendar event (robust to different key names)
        function mapBookingToEvent(booking) {
            const bookingId = getField(booking, 'booking_id', 'id', 'bookingId', 'ID');
            const date = getField(booking, 'booking_date', 'date', 'bookingDate', 'day');
            const start_time = getField(booking, 'start_time', 'start', 'startTime') || '09:00:00';
            const end_time = getField(booking, 'end_time', 'end', 'endTime') || '10:00:00';
            const status = (getField(booking, 'status', 'booking_status', 'state') || 'Pending').toString();
            const client_name = getField(booking, 'client_name', 'clientName', 'name') || 'Booking';

            if (!bookingId || !date) return null;

            // Normalize time format if necessary (ensure HH:MM:SS)
            const normalizeTime = (t) => {
                if (!t) return '00:00:00';
                // if format is HH:MM, append :00
                if (/^\d{2}:\d{2}$/.test(t)) return t + ':00';
                if (/^\d{2}:\d{2}:\d{2}$/.test(t)) return t;
                return String(t);
            };

            return {
                id: String(bookingId),
                title: client_name,
                start: `${date}T${normalizeTime(start_time)}`,
                end: `${date}T${normalizeTime(end_time)}`,
                className: `event-${status.toLowerCase()}`,
                extendedProps: {
                    type: 'booking',
                    data: booking
                }
            };
        }

        // Map block object from server to FullCalendar event
        function mapBlockToEvent(block) {
            const blockId = getField(block, 'block_id', 'id', 'blockId', 'ID');
            const date = getField(block, 'block_date', 'date', 'blockDate');
            // Accept 'true'/'false' strings as well
            const is_all_day_raw = getField(block, 'is_all_day', 'allDay', 'isAllDay');
            const is_all_day = (is_all_day_raw === true || is_all_day_raw === 'true' || is_all_day_raw === '1');
            const start_time = getField(block, 'start_time', 'start', 'startTime') || '00:00:00';
            const end_time = getField(block, 'end_time', 'end', 'endTime') || '23:59:59';
            const block_type = getField(block, 'block_type', 'type') || 'Blocked';

            if (!blockId || !date) return null;

            // For all-day events FullCalendar treats 'end' as exclusive: use next day for full day blocks
            if (is_all_day) {
                const endDate = addDaysToDateString(date, 1);
                return {
                    id: String(blockId),
                    title: block_type,
                    start: date,
                    end: endDate,
                    allDay: true,
                    className: 'event-block',
                    extendedProps: { type: 'block', data: block }
                };
            } else {
                const normalizeTime = (t) => {
                    if (!t) return '00:00:00';
                    if (/^\d{2}:\d{2}$/.test(t)) return t + ':00';
                    if (/^\d{2}:\d{2}:\d{2}$/.test(t)) return t;
                    return String(t);
                };
                return {
                    id: String(blockId),
                    title: block_type,
                    start: `${date}T${normalizeTime(start_time)}`,
                    end: `${date}T${normalizeTime(end_time)}`,
                    allDay: false,
                    className: 'event-block',
                    extendedProps: { type: 'block', data: block }
                };
            }
        }

        // Format month for API query (YYYY-MM)
        function formatMonthForAPI(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            return `${y}-${m}`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const email = getPhotographerEmail();
            document.getElementById('userEmail').textContent = email;

            await loadAllData(); // populates allEvents
            initCalendar();
        });

        // Refresh calendar with fresh data
        async function refreshCalendar() {
            showLoading(true);
            allEvents = []; // Clear existing events
            await loadAllData(true); // Force fresh data
            
            if (calendar) {
                calendar.removeAllEvents();
                // Add events array as an event source
                calendar.addEventSource(allEvents);
                calendar.render();
            }
            
            showLoading(false);
        }

        // Load data for entire year (defensive, logs raw responses)
        async function loadAllData(forceRefresh = false) {
            try {
                const email = getPhotographerEmail();
                const urlParams = new URLSearchParams(window.location.search);
                const debugMode = urlParams.get('debug') === 'true';
                
                console.log('=== LOADING CALENDAR DATA ===');
                console.log('User email:', email);
                console.log('Apps Script URL:', CONFIG.appsScriptUrl);
                console.log('Debug mode:', debugMode);
                console.log('Force refresh:', forceRefresh);
                
                showLoading(true);
                const promises = [];
                
                // Load several months of data (you can adjust range)
                for (let i = -2; i <= 12; i++) {
                    const date = new Date();
                    date.setMonth(date.getMonth() + i);
                    const month = formatMonthForAPI(date);
                    
                    // Add cache buster to force fresh data
                    const cacheBuster = forceRefresh ? `&t=${Date.now() + i}` : '';
                    const url = `${CONFIG.appsScriptUrl}?email=${encodeURIComponent(email)}&month=${month}${debugMode ? '&debug=true' : ''}${cacheBuster}`;
                    
                    console.log(`Queuing request for ${month}:`, url);
                    
                    // Defensive fetch: read text and try to parse JSON, log raw if not JSON
                    promises.push(
                        fetch(url)
                            .then(async resp => {
                                const text = await resp.text();
                                // Log truncated raw text for debugging
                                console.log(`Raw response (month ${month}) - first 2000 chars:`, text.slice(0, 2000));
                                try {
                                    return JSON.parse(text);
                                } catch (err) {
                                    console.error('Failed to parse JSON for URL:', url, 'error:', err);
                                    // Provide a helpful object to be handled later
                                    return { success: false, error: 'Invalid JSON response', raw: text, month };
                                }
                            })
                            .catch(err => {
                                console.error('Fetch error for', url, err);
                                return { success: false, error: err.message || String(err), month };
                            })
                    );
                }

                console.log('Fetching data from Apps Script...');
                const results = await Promise.all(promises);
                console.log('API responses received:', results.length);
                
                // Combine all data
                allEvents = [];
                results.forEach((data, index) => {
                    console.log(`Processing result ${index}:`, data);
                    
                    if (!data) {
                        console.warn('Empty response object at index', index);
                        return;
                    }
                    
                    // Show debug logs if present
                    if (data.debug) {
                        console.log(`\nðŸ“‹ DEBUG LOGS FOR MONTH ${data.month || 'unknown'}:`);
                        if (data.debug.bookings) {
                            console.log('\n=== BOOKINGS DEBUG ===');
                            data.debug.bookings.forEach(log => console.log(log));
                        }
                        if (data.debug.blocks) {
                            console.log('\n=== BLOCKS DEBUG ===');
                            data.debug.blocks.forEach(log => console.log(log));
                        }
                        console.log(''); // Empty line after debug
                    }
                    
                    if (data.success) {
                        console.log(`  Success! Bookings: ${data.bookings?.length || 0}, Blocks: ${data.blocks?.length || 0}`);
                        
                        // Add bookings (use mapping helper to be robust)
                        if (data.bookings && Array.isArray(data.bookings)) {
                            data.bookings.forEach(booking => {
                                const eventObj = mapBookingToEvent(booking);
                                if (eventObj) {
                                    console.log('  Adding booking event:', eventObj.id, eventObj.title, eventObj.start);
                                    allEvents.push(eventObj);
                                } else {
                                    console.warn('  Skipping booking due to missing id/date:', booking);
                                }
                            });
                        }
                        
                        // Add blocks
                        if (data.blocks && Array.isArray(data.blocks)) {
                            data.blocks.forEach(block => {
                                const eventObj = mapBlockToEvent(block);
                                if (eventObj) {
                                    console.log('  Adding block event:', eventObj.id, eventObj.title, eventObj.start);
                                    allEvents.push(eventObj);
                                } else {
                                    console.warn('  Skipping block due to missing id/date:', block);
                                }
                            });
                        }
                    } else {
                        console.error(`  Failed! Error: ${data.error}`);
                        if (data.raw) {
                            console.error('  Raw response (first 2000 chars):', data.raw.slice(0,2000));
                        }
                        if (data.stack) {
                            console.error('Stack trace:', data.stack);
                        }
                    }
                });
                
                console.log('Total events loaded:', allEvents.length);
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load calendar data. Please check the console for details.');
                showLoading(false);
            }
        }

        // Initialize FullCalendar
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                events: allEvents,
                editable: false,
                selectable: true,
                selectMirror: true,
                eventClick: handleEventClick,
                dateClick: handleDateClick,
                height: 'auto',
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: 'short'
                }
            });
            
            calendar.render();
        }

        // Handle clicking on an event
        function handleEventClick(info) {
            currentEvent = info.event;
            const type = info.event.extendedProps.type;
            const data = info.event.extendedProps.data;
            
            if (type === 'booking') {
                showBookingDetails(data);
            } else {
                showBlockDetails(data);
            }
        }

        // Handle clicking on a date
        function handleDateClick(info) {
            document.getElementById('formModalTitle').textContent = 'New Booking';
            document.getElementById('formBookingType').value = 'booking';
            document.getElementById('formBookingId').value = '';
            
            // Clear form, then set date and status
            document.getElementById('bookingForm').reset();
            document.getElementById('formDate').value = info.dateStr;
            document.getElementById('formStatus').value = 'Confirmed';
            
            toggleFormFields();
            document.getElementById('formModal').classList.add('active');
        }

        // Toggle between booking and block form fields
        function toggleFormFields() {
            const type = document.getElementById('formBookingType').value;
            
            if (type === 'booking') {
                document.getElementById('bookingFields').style.display = 'block';
                document.getElementById('blockFields').style.display = 'none';
            } else {
                document.getElementById('bookingFields').style.display = 'none';
                document.getElementById('blockFields').style.display = 'block';
            }
        }

        // Toggle time fields for all-day blocks
        function toggleTimeFields() {
            const allDay = document.getElementById('formAllDay').checked;
            document.getElementById('blockTimeFields').style.display = allDay ? 'none' : 'flex';
        }

        // Show booking details
        function showBookingDetails(booking) {
            const modal = document.getElementById('viewModal');
            modal.dataset.eventType = 'booking';
            modal.dataset.bookingData = JSON.stringify(booking);
            
            const status = booking && booking.status ? booking.status : (booking.booking_status || 'Pending');
            document.getElementById('viewModalTitle').textContent = `Booking: ${booking.client_name || booking.clientName || 'Booking'}`;
            
            const content = `
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">
                        <span class="status-badge ${String(status).toLowerCase()}">${status}</span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span class="detail-value">${booking.booking_date || booking.date || ''}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Time:</span>
                    <span class="detail-value">${booking.start_time || booking.start || ''} - ${booking.end_time || booking.end || ''}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Client:</span>
                    <span class="detail-value">${booking.client_name || booking.clientName || 'â€”'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${booking.client_email || booking.clientEmail || 'Not provided'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${booking.client_phone || booking.clientPhone || 'Not provided'}</span>
                </div>
                ${booking.shoot_level ? `
                <div class="detail-row">
                    <span class="detail-label">Shoot Level:</span>
                    <span class="detail-value">${booking.shoot_level}</span>
                </div>
                ` : ''}
                ${booking.location || booking.shoot_address ? `
                <div class="detail-row">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value">${booking.location || booking.shoot_address || ''}</span>
                </div>
                ` : ''}
                ${booking.amount_quoted ? `
                <div class="detail-row">
                    <span class="detail-label">Amount:</span>
                    <span class="detail-value">Â£${booking.amount_quoted}</span>
                </div>
                ` : ''}
                ${booking.notes ? `
                <div class="detail-row">
                    <span class="detail-label">Notes:</span>
                    <span class="detail-value">${booking.notes}</span>
                </div>
                ` : ''}
            `;
            
            document.getElementById('viewContent').innerHTML = content;
            modal.classList.add('active');
        }

        // Show block details
        function showBlockDetails(block) {
            const modal = document.getElementById('viewModal');
            modal.dataset.eventType = 'block';
            modal.dataset.blockData = JSON.stringify(block);
            
            document.getElementById('viewModalTitle').textContent = `Blocked Time: ${block.block_type || block.type || 'Blocked'}`;
            
            const content = `
                <div class="detail-row">
                    <span class="detail-label">Type:</span>
                    <span class="detail-value">${block.block_type || block.type || ''}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span class="detail-value">${block.block_date || block.date || ''}</span>
                </div>
                ${!(block.is_all_day === true || block.is_all_day === 'true') ? `
                <div class="detail-row">
                    <span class="detail-label">Time:</span>
                    <span class="detail-value">${block.start_time || block.start || ''} - ${block.end_time || block.end || ''}</span>
                </div>
                ` : `
                <div class="detail-row">
                    <span class="detail-label">All Day:</span>
                    <span class="detail-value">Yes</span>
                </div>
                `}
                ${block.notes ? `
                <div class="detail-row">
                    <span class="detail-label">Notes:</span>
                    <span class="detail-value">${block.notes}</span>
                </div>
                ` : ''}
            `;
            
            document.getElementById('viewContent').innerHTML = content;
            modal.classList.add('active');
        }

        // Save booking or block (GET with debug logging - keep this if Apps Script expects GET)
        async function saveBooking() {
            try {
                const type = document.getElementById('formBookingType').value;
                const bookingId = document.getElementById('formBookingId').value;
                
                let formData = {
                    user_email: getPhotographerEmail()
                };
                
                if (type === 'booking') {
                    formData = {
                        ...formData,
                        action: bookingId ? 'update_booking' : 'create_booking',
                        booking_id: bookingId,
                        client_name: document.getElementById('formClientName').value,
                        client_email: document.getElementById('formClientEmail').value,
                        client_phone: document.getElementById('formClientPhone').value,
                        client_company: document.getElementById('formClientCompany').value,
                        client_socials_url: document.getElementById('formClientSocials').value,
                        client_portfolio_url: document.getElementById('formClientPortfolio').value,
                        client_references_url: document.getElementById('formClientReferences').value,
                        date: document.getElementById('formDate').value,
                        start_time: document.getElementById('formStartTime').value,
                        end_time: document.getElementById('formEndTime').value,
                        duration_minutes: document.getElementById('formDuration').value,
                        status: document.getElementById('formStatus').value,
                        shoot_level: document.getElementById('formShootLevel').value,
                        shoot_address: document.getElementById('formShootAddress').value,
                        amount_quoted: document.getElementById('formTotalPayment').value,
                        pay_type: document.getElementById('formCompensation').value,
                        emergency_email: document.getElementById('formEmergencyEmail').value,
                        notes: document.getElementById('formNotes').value
                    };
                } else {
                    formData = {
                        ...formData,
                        action: 'create_block',
                        date: document.getElementById('formBlockDate').value,
                        start_time: document.getElementById('formBlockStartTime').value,
                        end_time: document.getElementById('formBlockEndTime').value,
                        is_all_day: document.getElementById('formAllDay').checked,
                        block_type: document.getElementById('formBlockType').value,
                        notes: document.getElementById('formBlockNotes').value
                    };
                }

                // Show loading
                showLoading(true);
                
                // Build URL and log it for debugging
                const params = new URLSearchParams(formData);
                const url = `${CONFIG.appsScriptUrl}?${params.toString()}&t=${Date.now()}`;
                console.log('Saving booking â€” GET URL:', url);
                console.log('Form data for save:', formData);

                // Simple fetch without custom headers (CORS-safe)
                const resp = await fetch(url);
                const raw = await resp.text();
                console.log('Raw save response (first 2000 chars):', raw.slice(0,2000));
                let result;
                try {
                    result = JSON.parse(raw);
                } catch (parseErr) {
                    console.error('Save response not valid JSON:', parseErr, raw);
                    alert('Server response was not valid JSON. Check the console (network tab) for details.');
                    showLoading(false);
                    return;
                }

                if (result.success) {
                    alert('Saved successfully! Refreshing calendar...');
                    closeModal('formModal');
                    
                    // Refresh calendar with fresh data
                    await refreshCalendar();
                } else {
                    console.error('Server returned error on save:', result);
                    alert('Error saving: ' + (result.error || 'Unknown error'));
                }
                
                showLoading(false);

            } catch (error) {
                console.error('Error saving:', error);
                alert('Failed to save. Please check the console for details.');
                showLoading(false);
            }
        }

        // Delete current event (CORS-safe version)
        async function deleteEvent() {
            const modal = document.getElementById('viewModal');
            const eventType = modal.dataset.eventType;
            
            if (!eventType || !confirm('Are you sure you want to delete this event?')) {
                return;
            }
            
            try {
                showLoading(true);

                let formData = { user_email: getPhotographerEmail() };

                if (eventType === 'booking') {
                    const booking = JSON.parse(modal.dataset.bookingData || '{}');
                    const bookingId = getField(booking, 'booking_id', 'id', 'bookingId');
                    if (!bookingId) {
                        alert('Booking ID not found.');
                        showLoading(false);
                        return;
                    }
                    formData.action = 'delete_booking';
                    formData.booking_id = bookingId;
                } else {
                    const block = JSON.parse(modal.dataset.blockData || '{}');
                    const blockId = getField(block, 'block_id', 'id', 'blockId');
                    if (!blockId) {
                        alert('Block ID not found.');
                        showLoading(false);
                        return;
                    }
                    formData.action = 'delete_block';
                    formData.block_id = blockId;
                }

                const params = new URLSearchParams(formData);
                const url = `${CONFIG.appsScriptUrl}?${params.toString()}&t=${Date.now()}`;
                console.log('Deleting event â€” URL:', url);

                const resp = await fetch(url);
                const raw = await resp.text();
                console.log('Raw delete response (first 2000 chars):', raw.slice(0,2000));
                let result;
                try {
                    result = JSON.parse(raw);
                } catch (parseErr) {
                    console.error('Delete response not valid JSON:', parseErr, raw);
                    alert('Server response was not valid JSON. Check the console (network tab) for details.');
                    showLoading(false);
                    return;
                }

                if (result.success) {
                    alert('Deleted successfully! Refreshing calendar...');
                    closeModal('viewModal');
                    await refreshCalendar();
                } else {
                    console.error('Server returned error on delete:', result);
                    alert('Error deleting: ' + (result.error || 'Unknown error'));
                }

                showLoading(false);
            } catch (err) {
                console.error('Error deleting event:', err);
                alert('Failed to delete event. Check console for details.');
                showLoading(false);
            }
        }

        // Edit current event - populate the form and open it
        function editEvent() {
            const modal = document.getElementById('viewModal');
            const eventType = modal.dataset.eventType;
            if (!eventType) return;

            if (eventType === 'booking') {
                const booking = JSON.parse(modal.dataset.bookingData || '{}');
                document.getElementById('formModalTitle').textContent = 'Edit Booking';
                document.getElementById('formBookingType').value = 'booking';
                document.getElementById('formBookingId').value = getField(booking, 'booking_id', 'id', 'bookingId') || '';

                // Fill fields (use fallbacks)
                document.getElementById('formClientName').value = getField(booking, 'client_name', 'clientName', 'name') || '';
                document.getElementById('formClientEmail').value = getField(booking, 'client_email', 'clientEmail') || '';
                document.getElementById('formClientPhone').value = getField(booking, 'client_phone', 'clientPhone') || '';
                document.getElementById('formClientCompany').value = getField(booking, 'client_company') || '';
                document.getElementById('formClientSocials').value = getField(booking, 'client_socials_url') || '';
                document.getElementById('formClientPortfolio').value = getField(booking, 'client_portfolio_url') || '';
                document.getElementById('formClientReferences').value = getField(booking, 'client_references_url') || '';
                document.getElementById('formDate').value = getField(booking, 'booking_date', 'date') || '';
                document.getElementById('formStartTime').value = getField(booking, 'start_time', 'start') || '';
                document.getElementById('formEndTime').value = getField(booking, 'end_time', 'end') || '';
                document.getElementById('formDuration').value = getField(booking, 'duration_minutes') || '';
                document.getElementById('formStatus').value = getField(booking, 'status') || '';
                document.getElementById('formShootLevel').value = getField(booking, 'shoot_level') || '';
                document.getElementById('formShootAddress').value = getField(booking, 'shoot_address', 'location') || '';
                document.getElementById('formTotalPayment').value = getField(booking, 'amount_quoted') || '';
                document.getElementById('formCompensation').value = getField(booking, 'pay_type') || '';
                document.getElementById('formEmergencyEmail').value = getField(booking, 'emergency_email') || '';
                document.getElementById('formNotes').value = getField(booking, 'notes') || '';

                toggleFormFields();
                document.getElementById('viewModal').classList.remove('active');
                document.getElementById('formModal').classList.add('active');
            } else {
                const block = JSON.parse(modal.dataset.blockData || '{}');
                document.getElementById('formModalTitle').textContent = 'Edit Block';
                document.getElementById('formBookingType').value = 'block';
                document.getElementById('formBookingId').value = getField(block, 'block_id', 'id', 'blockId') || '';

                document.getElementById('formBlockDate').value = getField(block, 'block_date', 'date') || '';
                document.getElementById('formBlockType').value = getField(block, 'block_type', 'type') || '';
                const isAll = getField(block, 'is_all_day', 'allDay') === true || getField(block, 'is_all_day', 'allDay') === 'true';
                document.getElementById('formAllDay').checked = !!isAll;
                document.getElementById('formBlockStartTime').value = getField(block, 'start_time', 'start') || '';
                document.getElementById('formBlockEndTime').value = getField(block, 'end_time', 'end') || '';
                document.getElementById('formBlockNotes').value = getField(block, 'notes') || '';

                toggleFormFields();
                toggleTimeFields();
                document.getElementById('viewModal').classList.remove('active');
                document.getElementById('formModal').classList.add('active');
            }
        }

        // Close a modal by id
        function closeModal(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('active');

            // clear any dataset payloads to avoid stale data
            if (id === 'viewModal') {
                delete el.dataset.eventType;
                delete el.dataset.bookingData;
                delete el.dataset.blockData;
            }
        }

        // End of script
    </script>
</body>
</html>
